@model Resgrid.Web.Models.WorkflowCredentialViewModel
@using Resgrid.Model
@inject IStringLocalizer<Resgrid.Localization.Areas.User.Workflows.Workflows> localizer
@{
    ViewData["Title"] = "Resgrid | " + localizer["AddCredentialHeader"];
    Layout = "~/Areas/User/Views/Shared/_UserLayout.cshtml";
    var credTypes = Enum.GetValues(typeof(WorkflowCredentialType))
                       .Cast<WorkflowCredentialType>()
                       .Select(e => new SelectListItem
                       {
                           Value = ((int)e).ToString(),
                           Text = e switch
                           {
                               WorkflowCredentialType.Smtp => "SMTP (Email)",
                               WorkflowCredentialType.Twilio => "Twilio (SMS/Voice)",
                               WorkflowCredentialType.Ftp => "FTP",
                               WorkflowCredentialType.Sftp => "SFTP",
                               WorkflowCredentialType.AwsS3 => "AWS S3",
                               WorkflowCredentialType.HttpBearer => "HTTP Bearer Token",
                               WorkflowCredentialType.HttpBasic => "HTTP Basic Auth",
                               WorkflowCredentialType.HttpApiKey => "HTTP API Key",
                               WorkflowCredentialType.MicrosoftTeams => "Microsoft Teams Webhook",
                               WorkflowCredentialType.Slack => "Slack",
                               WorkflowCredentialType.Discord => "Discord",
                               WorkflowCredentialType.AzureBlobStorage => "Azure Blob Storage",
                               WorkflowCredentialType.Box => "Box",
                               WorkflowCredentialType.Dropbox => "Dropbox",
                               _ => e.ToString()
                           }
                       });
}

<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-sm-4">
        <h2>@localizer["AddCredentialHeader"]</h2>
        <ol class="breadcrumb">
            <li><a asp-controller="Home" asp-action="Dashboard" asp-route-area="User">@commonLocalizer["HomeModule"]</a></li>
            <li><a asp-action="Index">@localizer["WorkflowsHeader"]</a></li>
            <li><a asp-action="Credentials">@localizer["Credentials"]</a></li>
            <li class="active"><strong>@localizer["New"]</strong></li>
        </ol>
    </div>
</div>

<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-lg-8 col-lg-offset-2">
            <div class="ibox">
                <div class="ibox-title"><h5>@localizer["CredentialDetails"]</h5></div>
                <div class="ibox-content">
                    @if (!ViewData.ModelState.IsValid)
                    {
                        <div class="alert alert-danger">
                            <strong><i class="fa fa-exclamation-triangle"></i> @localizer["ValidationErrorHeader"]</strong>
                            <div asp-validation-summary="All" class="mt-1"></div>
                        </div>
                    }
                    <form asp-action="CredentialNew" method="post">
                        @Html.AntiForgeryToken()

                        <div class="form-group">
                            <label asp-for="Name">@localizer["Name"] <span class="text-danger">*</span></label>
                            <input asp-for="Name" class="form-control" placeholder="e.g. Production SMTP" required />
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="CredentialType">@localizer["CredentialType"] <span class="text-danger">*</span></label>
                            <select asp-for="CredentialType" asp-items="@credTypes" class="form-control" id="credentialTypeSelect"></select>
                        </div>

                        @await Html.PartialAsync("_CredentialFields", Model)

                        <button type="submit" class="btn btn-primary">@localizer["SaveCredential"]</button>
                        <a asp-action="Credentials" class="btn btn-default">@localizer["Cancel"]</a>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            var select = document.getElementById('credentialTypeSelect');

            function showPanel() {
                var val = parseInt(select.value, 10);
                document.querySelectorAll('.cred-panel').forEach(function (p) {
                    p.style.display = 'none';
                    p.querySelectorAll('input,textarea,select').forEach(function (f) { f.disabled = true; });
                });
                var panel = document.getElementById('cred-panel-' + val);
                if (panel) {
                    panel.style.display = 'block';
                    panel.querySelectorAll('input,textarea,select').forEach(function (f) { f.disabled = false; });
                }
            }

            // ASP.NET Core tag helpers add .field-validation-error to the <span> only
            // when there is a model-state error for that field — use that as the
            // reliable indicator rather than :not(:empty) which fails on whitespace.
            function revealErrorPanels() {
                document.querySelectorAll('.cred-panel').forEach(function (p) {
                    if (p.querySelector('.field-validation-error')) {
                        var idx = parseInt(p.id.replace('cred-panel-', ''), 10);
                        if (!isNaN(idx)) {
                            select.value = idx;
                        }
                    }
                });
            }

            // Before the form submits, re-enable every panel's inputs so that all
            // fields are included in the POST and the model-binder can populate them.
            // The controller ignores fields from inactive panels via IValidatableObject.
            var form = select.closest('form');
            form.addEventListener('submit', function () {
                document.querySelectorAll('.cred-panel input, .cred-panel textarea, .cred-panel select')
                    .forEach(function (f) { f.disabled = false; });
            });

            revealErrorPanels();
            select.addEventListener('change', showPanel);
            showPanel();
        })();
    </script>
}
